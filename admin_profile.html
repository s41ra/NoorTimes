<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile | Islamic App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ====================================================================
        1. Base & Utilities (DARK THEME - LANDSCAPE/PORTRAIT)
        ==================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #172B26; /* Dark Theme Background */
            color: #f1f5f9; /* Tailwind slate-100 for default text */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh; /* Ensure full viewport height */
        }

        /* Profile Card */
        .profile-card {
            background: #213A33; /* Card Background */
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Field labels */
        .field-label {
            font-size: 0.75rem;
            color: #94a3b8; /* Tailwind slate-400 - Light gray for labels */
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Form Input Styling */
        .profile-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #475569; /* Slate-600 border */
            border-radius: 8px;
            background-color: #1E3A33; /* Slightly lighter card color */
            color: #f1f5f9;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .profile-input:focus {
            outline: none;
            border-color: #059669; /* Emerald-600 focus */
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.5);
        }

        /* Style for disabled inputs */
        .profile-input:disabled {
            background-color: #213a33; /* Matches card background to look read-only */
            border-color: #213a33;
            color: #94a3b8; /* Lighter text color to show read-only */
        }


        /* Update Button Style */
        .update-button {
            width: 100%;
            padding: 0.75rem;
            background-color: #059669; /* Emerald-600 */
            color: white;
            font-weight: 600;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        
        .update-button:hover {
            background-color: #047857; /* Emerald-700 */
        }
        
        /* Profile Image Container */
        .profile-image-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #2c473f; /* Placeholder background */
            border: 3px solid #059669;
            margin: 0 auto 12px;
        }

        /* Profile Image */
        .profile-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Comment Item Styling (Similar to event page, but adapted) */
        .user-comment-item {
            background-color: #2c473f; /* Darker gray for comment background */
            border-left: 3px solid #059669; /* Emerald border for emphasis */
        }
        
        /* Edit/Delete Button Style */
        .action-button {
            color: #34d399; /* Emerald-400 */
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.75rem;
            transition: color 0.2s;
        }
        
        .action-button:hover {
            color: #10b981; /* Emerald-500 */
        }

        /* Style for the new Edit/Cancel Button */
        .edit-toggle-button {
            width: 100%; /* Make it full width for mobile */
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 0.75rem; /* Space before the next element */
        }

        .edit-mode-on {
            background-color: #ef4444; /* Red-500 for 'Cancel' */
            color: white;
        }
        .edit-mode-on:hover {
            background-color: #dc2626; /* Red-600 */
        }

        .edit-mode-off {
            background-color: #34d399; /* Emerald-400 for 'Edit' */
            color: #172B26;
        }
        .edit-mode-off:hover {
            background-color: #10b981; /* Emerald-500 */
        }

        /* Star Rating Custom Styles */
        .rating-input {
            width: 100%;
            height: 48px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
            padding: 0 0.75rem;
            background: #1E3A33; /* Match input background */
            border: 1px solid #475569;
            border-radius: 8px;
        }

    </style>
</head>
<body class="flex flex-col items-center p-4">

<main class="w-full max-w-md mx-auto pt-4 pb-20">
    <h2 class="text-2xl font-bold text-gray-100 mb-6 text-center">Your Profile Dashboard</h2>

    <div class="profile-card p-6 mb-8">
        <div class="text-center mb-6">
            <div class="profile-image-container">
                <img id="profile-image-display" class="profile-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 016 0zm6 3a9 9 0 11-18 0 9 9 3 0118 0z' /%3E%3C/svg%3E" alt="Profile Picture"/>
            </div>

            <h1 id="profile-username" class="text-xl font-extrabold text-white">Loading Username...</h1>
        </div>

        <div class="mb-6 pt-4 border-t border-gray-700">
            <h3 class="text-sm font-bold text-gray-100 mb-3 uppercase tracking-wider">Update Profile Picture</h3>
            <input type="file" id="profile-pic-input" accept="image/*" class="profile-input mb-3" onchange="document.getElementById('upload-status').textContent = this.files.length > 0 ? 'File selected. Click Upload.' : '';">
            <button id="upload-profile-pic-btn" class="update-button" onclick="uploadProfilePic()">
                Upload Photo
            </button>
            <div id="upload-status" class="text-center text-sm mt-3 text-yellow-400" style="opacity: 0;"></div>
        </div>

        <div class="space-y-4 pt-4 border-t border-gray-700">
            <div>
                <span class="field-label">YOUR USERNAME</span>
                <p id="profile-id" class="text-sm font-mono text-gray-300">Loading ID...</p>
            </div>

            <div>
                <span class="field-label">Current Role / Status</span>
                <p class="text-sm text-emerald-300 font-semibold">Community Member</p>
            </div>

            <div>
                <span class="field-label">Total Comments Posted</span>
                <p id="comment-count" class="text-sm text-gray-300">0</p>
            </div>

            <div class="pt-2 border-t border-gray-700">
                <span class="field-label">Location (From Firestore)</span>
                <p id="profile-location" class="text-sm text-gray-300">N/A</p>
            </div>
        </div>
    </div>

    <div class="profile-card p-6 mb-8">
        <h3 class="text-xl font-bold text-gray-100 text-center mb-4 border-b border-gray-700 pb-2">
            Review the App ‚≠ê
        </h3>
        <form id="app-review-form" onsubmit="event.preventDefault(); submitAppReview();">
            <div class="mb-4">
                <label for="review-star-rating" class="field-label text-white">Your Rating (1 to 10 Stars)</label>
                <input type="number" id="review-star-rating" class="profile-input rating-input"
                       min="1" max="10" step="1" value="10" required>
            </div>

            <button type="submit" id="submit-review-btn" class="update-button">Submit Review</button>
            <div id="review-alert-status" class="text-center text-sm mt-3" style="opacity: 0;"></div>
        </form>
    </div>

    <div class="profile-card p-6 mb-8">
        <h3 class="text-xl font-bold text-gray-100 text-center mb-4 border-b border-gray-700 pb-2">
            Update Your Personal Details
        </h3>
        <button id="edit-toggle-btn" class="edit-toggle-button edit-mode-off" onclick="toggleEditMode()">
            Edit Details
        </button>
        <form id="profile-update-form" onsubmit="event.preventDefault(); updateProfileDetails();">
            <fieldset id="profile-fieldset" disabled>
                <div class="mb-4">
                    <label for="full-name" class="field-label text-white">Full Name</label>
                    <input type="text" id="full-name" class="profile-input" placeholder="Enter your full name">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="mobile-phone" class="field-label text-white">Mobile Phone</label>
                        <input type="tel" id="mobile-phone" class="profile-input" placeholder="e.g., 09xxxxxxxxx">
                    </div>
                    <div>
                        <label for="barangay" class="field-label text-white">Barangay</label>
                        <input type="text" id="barangay" class="profile-input" placeholder="e.g., Bago Gallera">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="city-municipality" class="field-label text-white">City/Municipality</label>
                        <input type="text" id="city-municipality" class="profile-input" placeholder="e.g., Davao City">
                    </div>
                    <div>
                        <label for="province" class="field-label text-white">Province</label>
                        <input type="text" id="province" class="profile-input" placeholder="e.g., Davao del Sur">
                    </div>
                </div>

                <div class="mb-6">
                    <label for="profile-password" class="field-label text-white">Password</label>
                    <input type="password" id="profile-password" class="profile-input" placeholder="********">
                </div>
            </fieldset>

            <button type="submit" id="save-changes-btn" class="update-button hidden">Update Profile</button>
            <div id="update-alert-status" class="text-center text-sm mt-3" style="opacity: 0;"></div>
        </form>
    </div>

    <h3 class="text-xl font-semibold text-gray-100 mb-4 border-b border-gray-700 pb-2">Recent Comments</h3>

    <div id="user-comments-list" class="space-y-4">
        <p id="loading-comments" class="text-center text-gray-400 font-medium mt-8">Loading your activity...</p>
    </div>

    <p id="no-comments" class="text-center text-gray-400 font-medium mt-8 hidden">
        You haven't posted any comments yet.
    </p>

</main>

<script type="module">
    // --- 1. Firebase Setup & Initialization ---
    // Realtime Database (RTDB) for comments, profile image URL, and reviews
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref as rtdbRef, onValue, get, child, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // Cloud Firestore for user personal data
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Firebase Storage for profile pictures
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";


    const firebaseConfig = {
        apiKey: "AIzaSyByJOqTUojiL1wN7_i_cHMAukuJWzIZVck",
        authDomain: "clothsuggest.firebaseapp.com",
        databaseURL: "https://clothsuggest-default-rtdb.firebaseio.com/",
        projectId: "clothsuggest",
        storageBucket: "clothsuggest.firebasestorage.app",
        messagingSenderId: "758790774735",
        appId: "1:758790774735:web:5f5ea17048273416cd7cba",
        measurementId: "G-4H8WZL0S4F"
    };

    const app = initializeApp(firebaseConfig);
    const dbRTDB = getDatabase(app); // For Realtime Database (Comments, Image URL, Reviews)
    const dbFirestore = getFirestore(app); // For Cloud Firestore (User Data)
    const storage = getStorage(app); // For Firebase Storage (Profile Image File)

    // --- 2. DOM Elements & State Variables ---
    const profileUsernameEl = document.getElementById("profile-username");
    const profileIdEl = document.getElementById("profile-id");
    const commentCountEl = document.getElementById("comment-count");
    const commentsListEl = document.getElementById("user-comments-list");
    const loadingCommentsEl = document.getElementById("loading-comments");
    const noCommentsEl = document.getElementById("no-comments");
    const updateAlertStatusEl = document.getElementById("update-alert-status");
    const profileLocationEl = document.getElementById("profile-location");
    const profileImageDisplayEl = document.getElementById("profile-image-display");
    const profilePicInput = document.getElementById("profile-pic-input");
    const uploadStatusEl = document.getElementById("upload-status");

    // New Review Elements
    const reviewStarRatingInput = document.getElementById("review-star-rating");
    const reviewAlertStatusEl = document.getElementById("review-alert-status");

    // Form Elements
    const profileFieldset = document.getElementById("profile-fieldset");
    const editToggleBtn = document.getElementById("edit-toggle-btn");
    const saveChangesBtn = document.getElementById("save-changes-btn");

    // Form Inputs
    const fullNameInput = document.getElementById("full-name");
    const mobilePhoneInput = document.getElementById("mobile-phone");
    const barangayInput = document.getElementById("barangay");
    const cityMunicipalityInput = document.getElementById("city-municipality");
    const provinceInput = document.getElementById("province");
    const passwordInput = document.getElementById("profile-password");

    // üõë REMOVED: Manual Input Elements (manualUserIdInput, loadTestProfileBtn)

    // Global variables to hold the current user ID and Username
    let CURRENT_USER_ID;
    let CURRENT_USER_USERNAME;

    // State variable for edit mode
    let isEditing = false;


    // --- 3. User ID Determination ---

    /** Determines the CURRENT_USER_ID and CURRENT_USER_USERNAME. */
    function getUserId() {
        // 1. Check Android bridge (Prioritized method to get user info)
        const androidId = (window.Android && typeof window.Android.getUserId === 'function' ?
            window.Android.getUserId() : null);
        const androidUsername = (window.Android && typeof window.Android.getUsername === 'function' ?
            window.Android.getUsername() : null);

        if (androidId && androidUsername) {
            // Using remembered instructions: "I am using an anonymous id." and "The username is came from the provided signup code."
            CURRENT_USER_ID = androidId;
            CURRENT_USER_USERNAME = androidUsername;
            return;
        }

        // 2. Default (Fallback) if Android bridge is not present (e.g., debugging in a browser)
        // Use remembered info for default username (based on user's instruction)
        const rememberedUsername = 'came from the provided signup code';

        // Use the remembered username as both ID and Username for Firebase interactions
        CURRENT_USER_ID = rememberedUsername;
        CURRENT_USER_USERNAME = rememberedUsername;

        // If the remembered string is still too generic, set a hardcoded fallback
        if (CURRENT_USER_USERNAME === 'came from the provided signup code') {
            CURRENT_USER_USERNAME = "anon_user_xyz";
            CURRENT_USER_ID = "anon_user_xyz";
        }
    }

    // --- 4. Utility Functions ---
    /** Helper function for human-readable time (e.g., '5 minutes ago') */
    function timeSince(date) {
        if (!date) return 'Just now';
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        return Math.floor(seconds) + " seconds ago";
    }

    /** Function to display transient alert for profile updates */
    function showUpdateAlert(message, type = 'success', element = updateAlertStatusEl) {
        let color = '';
        const targetElement = (element === updateAlertStatusEl && type.includes('upload')) ? uploadStatusEl : element;

        if (type === 'success') {
            color = 'text-green-400';
        } else if (type === 'error') {
            color = 'text-red-400';
        } else if (type === 'info' || type === 'upload-status') {
            color = 'text-yellow-400';
        }

        targetElement.className = `text-center text-sm mt-3 ${color}`;
        targetElement.textContent = message;
        targetElement.style.opacity = 1;

        // Hide after 3 seconds
        setTimeout(() => {
            targetElement.style.opacity = 0;
        }, 3000);
    }

    /** Function to clear all form inputs */
    function clearFormInputs() {
        fullNameInput.value = '';
        mobilePhoneInput.value = '';
        barangayInput.value = '';
        cityMunicipalityInput.value = '';
        provinceInput.value = '';
        passwordInput.value = '';
        profileLocationEl.textContent = "N/A";
        // Reset profile image to default SVG
        profileImageDisplayEl.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 016 0zm6 3a9 9 0 11-18 0 9 9 3 0118 0z' /%3E%3C/svg%3E";
    }

    /** Toggles the edit mode for the profile form */
    window.toggleEditMode = function(showCancelAlert = true) {
        isEditing = !isEditing;
        profileFieldset.disabled = !isEditing;

        if (isEditing) {
            editToggleBtn.textContent = 'Cancel Edit';
            editToggleBtn.classList.remove('edit-mode-off');
            editToggleBtn.classList.add('edit-mode-on');
            saveChangesBtn.classList.remove('hidden');
            showUpdateAlert("Edit mode activated. You can now modify your details.", 'info');
        } else {
            editToggleBtn.textContent = 'Edit Details';
            editToggleBtn.classList.remove('edit-mode-on');
            editToggleBtn.classList.add('edit-mode-off');
            saveChangesBtn.classList.add('hidden');

            if (showCancelAlert) {
                showUpdateAlert("Edit mode cancelled. Details are read-only.", 'info');
                loadProfileDetails();
            }
        }
    }


    // --- 5. Profile Detail Logic (Firestore & RTDB) ---

    /** Fetch existing user profile details from Firestore & RTDB. */
    async function loadProfileDetails() {
        // üí° UPDATED: Check for generic fallback username
        if (!CURRENT_USER_USERNAME || CURRENT_USER_USERNAME === "anon_user_xyz") {
            showUpdateAlert("Profile access denied. Username is generic or missing (Load from Android).", 'error');
            clearFormInputs();
            return;
        }

        // 5a. Fetch Personal Details from Firestore (islamusers/{username})
        const userDocRef = doc(dbFirestore, "islamusers", CURRENT_USER_USERNAME);

        try {
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                const data = docSnap.data();

                fullNameInput.value = data.full_name || '';
                mobilePhoneInput.value = data.mobile_phone || '';
                barangayInput.value = data.barangay || '';
                cityMunicipalityInput.value = data.city_municipality || '';
                provinceInput.value = data.province || '';
                passwordInput.value = data.password || '';

                // Update Location Display
                const location = [data.barangay, data.city_municipality, data.province]
                                     .filter(Boolean)
                                     .join(', ');
                profileLocationEl.textContent = location || "Location data not set.";
            } else {
                console.log(`No Firestore profile found for ${CURRENT_USER_USERNAME}.`);
                clearFormInputs();
                profileLocationEl.textContent = `Error: Document '${CURRENT_USER_USERNAME}' not found.`;
                showUpdateAlert(`Error: Profile for '${CURRENT_USER_USERNAME}' not found in Firestore. Data cannot be loaded.`, 'error');
            }
        } catch (error) {
            console.error("Error loading profile details from Firestore:", error);
            clearFormInputs();
            showUpdateAlert("Fatal error loading profile details.", 'error');
        }

        // 5b. Fetch Profile Picture URL from Realtime Database (user_profile/{username}/imageurl)
        const profilePicRef = rtdbRef(dbRTDB, `user_profile/${CURRENT_USER_USERNAME}/imageurl`);
        try {
            const picSnapshot = await get(profilePicRef);
            if (picSnapshot.exists() && picSnapshot.val()) {
                // Update the image source if a URL is found
                profileImageDisplayEl.src = picSnapshot.val();
            } else {
                // Keep default SVG if no picture is found
                profileImageDisplayEl.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 016 0zm6 3a9 9 0 11-18 0 9 9 3 0118 0z' /%3E%3C/svg%3E";
            }
        } catch (error) {
            console.error("Error loading profile picture URL from RTDB:", error);
        }
    }

    /** Update user profile details in Firestore */
    window.updateProfileDetails = async function() {
        if (!CURRENT_USER_USERNAME || CURRENT_USER_USERNAME === "anon_user_xyz") {
            showUpdateAlert("Cannot save. Username is generic or missing (Load from Android).", 'error');
            return;
        }

        // Firestore Path: islamusers/{username}
        const userDocRef = doc(dbFirestore, "islamusers", CURRENT_USER_USERNAME);

        try {
            const updates = {
                full_name: fullNameInput.value.trim(),
                mobile_phone: mobilePhoneInput.value.trim(),
                barangay: barangayInput.value.trim(),
                city_municipality: cityMunicipalityInput.value.trim(),
                province: provinceInput.value.trim(),
                password: passwordInput.value,
                username: CURRENT_USER_USERNAME,
                last_updated: new Date().toISOString()
            };

            await setDoc(userDocRef, updates, { merge: true });

            showUpdateAlert("Profile updated successfully!", 'success');

            // Re-load to update the displayed location in the profile card
            loadProfileDetails();

            // Switch back to read-only mode after successful save
            isEditing = false;
            profileFieldset.disabled = true;
            editToggleBtn.textContent = 'Edit Details';
            editToggleBtn.classList.remove('edit-mode-on');
            editToggleBtn.classList.add('edit-mode-off');
            saveChangesBtn.classList.add('hidden');


        } catch (error) {
            console.error("Error updating profile in Firestore:", error);
            showUpdateAlert("Failed to save changes to Firestore. ‚ùå", 'error');
        }
    }

    /** Uploads the profile picture file to Storage and saves the URL to RTDB */
    window.uploadProfilePic = async function() {
        if (!CURRENT_USER_USERNAME || CURRENT_USER_USERNAME === "anon_user_xyz") {
            showUpdateAlert("Cannot upload. Username is generic or missing (Load from Android).", 'error');
            return;
        }

        const file = profilePicInput.files[0];
        if (!file) {
            showUpdateAlert("Please select a file first.", 'error', uploadStatusEl);
            return;
        }

        try {
            // 1. Upload to Firebase Storage
            showUpdateAlert("Uploading... Please wait!", 'upload-status', uploadStatusEl);

            // Storage Path: profile_pictures/{username}
            const imageRef = storageRef(storage, `profile_pictures/${CURRENT_USER_USERNAME}`);
            const uploadResult = await uploadBytes(imageRef, file);

            // 2. Get the public download URL
            showUpdateAlert("File uploaded!...", 'upload-status', uploadStatusEl);
            const imageUrl = await getDownloadURL(uploadResult.ref);

            // 3. Save the URL to Realtime Database
            showUpdateAlert("Loading...", 'upload-status', uploadStatusEl);
            // RTDB Path: user_profile/{username}/imageurl
            const userProfileRef = rtdbRef(dbRTDB, `user_profile/${CURRENT_USER_USERNAME}`);
            await set(userProfileRef, {
                imageurl: imageUrl,
                uploaded_at: new Date().toISOString()
            });

            // 4. Update the UI
            profileImageDisplayEl.src = imageUrl;
            profilePicInput.value = ''; // Clear file input
            showUpdateAlert("Profile picture updated successfully!", 'success', uploadStatusEl);

        } catch (error) {
            console.error("Error uploading profile picture:", error);
            showUpdateAlert("Upload failed. Check console for details. ‚ùå", 'error', uploadStatusEl);
        }
    }

    // --- 6. App Review Logic (RTDB) ---

    /** Submits the user's star rating to Realtime Database. */
    window.submitAppReview = async function() {
        if (!CURRENT_USER_USERNAME || CURRENT_USER_USERNAME === "anon_user_xyz") {
            showUpdateAlert("Cannot submit review. Username is generic or missing (Load from Android).", 'error', reviewAlertStatusEl);
            return;
        }

        const starRating = parseInt(reviewStarRatingInput.value);

        if (isNaN(starRating) || starRating < 1 || starRating > 10) {
            showUpdateAlert("Please select a rating between 1 and 10.", 'error', reviewAlertStatusEl);
            return;
        }

        // RTDB Path: review_star/{username}/star
        const reviewRef = rtdbRef(dbRTDB, `review_star/${CURRENT_USER_USERNAME}`);

        try {
            await set(reviewRef, {
                star: starRating,
                timestamp: Date.now()
            });

            showUpdateAlert(`Thank you! Your ${starRating}/10 rating has been saved. ‚≠ê`, 'success', reviewAlertStatusEl);
        } catch (error) {
            console.error("Error submitting app review to RTDB:", error);
            showUpdateAlert("Failed to submit review. Please try again. ‚ùå", 'error', reviewAlertStatusEl);
        }
    }

    // --- 7. Main Dashboard Logic (RTDB for comments) ---

    function initializeProfile() {
        // 1. Get the current user ID and Username based on priority
        getUserId();

        // 2. Update user information section
        profileUsernameEl.textContent = CURRENT_USER_USERNAME;
        profileIdEl.textContent = CURRENT_USER_USERNAME; // Using username as the Firestore Document ID

        // 3. Load editable details from Firestore and profile picture URL from RTDB
        loadProfileDetails();

        // 4. Start fetching user comments from RTDB
        fetchUserComments();
    }

    // üõë REMOVED: Event listener for manual ID load button (since the button is gone)

    /**
     * Fetches all comments from all events and filters them for the current user. (Uses RTDB)
     */
    async function fetchUserComments() {
        // Reset state
        loadingCommentsEl.classList.remove('hidden');
        commentsListEl.innerHTML = '';
        noCommentsEl.classList.add('hidden');
        commentCountEl.textContent = '0'; 

        if (!CURRENT_USER_ID) {
            loadingCommentsEl.textContent = "Error: User ID is undefined.";
            return;
        }
        
        try {
            // Use RTDB functions and reference
            const commentsRef = rtdbRef(dbRTDB, 'comments');
            const commentsSnapshot = await get(commentsRef);
            
            if (!commentsSnapshot.exists()) {
                loadingCommentsEl.classList.add('hidden');
                noCommentsEl.classList.remove('hidden');
                return;
            }
            
            const allCommentsData = commentsSnapshot.val();
            const userComments = [];
            
            // 1. Traverse all events and collect only the current user's comments (based on CURRENT_USER_ID, which is the RTDB ID)
            for (const eventId in allCommentsData) {
                const eventComments = allCommentsData[eventId];
                for (const commentId in eventComments) {
                    const comment = eventComments[commentId];
                    // Filter by CURRENT_USER_ID (RTDB ID)
                    if (comment.userId === CURRENT_USER_ID) { 
                        userComments.push({
                            eventId: eventId,
                            commentId: commentId,
                            ...comment
                        });
                    }
                }
            }

            // Update comment count
            commentCountEl.textContent = userComments.length;
            
            if (userComments.length === 0) {
                loadingCommentsEl.classList.add('hidden');
                noCommentsEl.classList.remove('hidden');
                return;
            }

            // 2. Sort by timestamp (newest first)
            userComments.sort((a, b) => b.timestamp - a.timestamp);

            // 3. Fetch event titles for context (Still using RTDB)
            const eventTitles = {};
            const eventsRef = rtdbRef(dbRTDB, 'events');
            
            // Collect all unique event IDs to fetch
            const uniqueEventIds = [...new Set(userComments.map(c => c.eventId))];
            
            await Promise.all(uniqueEventIds.map(async (id) => {
                const eventSnapshot = await get(child(eventsRef, id));
                if (eventSnapshot.exists()) {
                    eventTitles[id] = eventSnapshot.val().title || 'Untitled Event';
                } else {
                    eventTitles[id] = 'Deleted Event';
                }
            }));

            // 4. Render the list
            let commentsHtml = userComments.map(comment => {
                const timeAgo = timeSince(comment.timestamp);
                const eventTitle = eventTitles[comment.eventId] || 'Unknown Event';
                
                const eventLink = `#event-${comment.eventId}`; 
                
                return `
                    <div class="p-4 user-comment-item rounded-lg">
                        <div class="flex items-start justify-between">
                            <h4 class="text-sm font-semibold text-emerald-400 mb-1">
                                Comment on: <a href="${eventLink}" class="hover:underline">${eventTitle}</a>
                            </h4>
                            <span class="text-xs text-gray-500 flex-shrink-0">${timeAgo}</span>
                        </div>
                        <p class="text-sm text-gray-300 mt-1">${comment.text}</p>
                        <div class="mt-2 text-right">
                            <button onclick="alert('Delete functionality not implemented yet for RTDB comments.')"
                                class="action-button text-red-400 hover:text-red-500">
                                Delete Comment
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            commentsListEl.innerHTML = commentsHtml;
            loadingCommentsEl.classList.add('hidden');

        } catch (error) {
            console.error("Error fetching user comments:", error);
            loadingCommentsEl.classList.add('hidden');
            commentsListEl.innerHTML = `<p class="text-center text-red-400 font-medium mt-8">
                An error occurred while loading your activity from Realtime DB.
            </p>`;
        }
    }

    // Call the function when the script loads
    initializeProfile();
</script>

</body>
</html>