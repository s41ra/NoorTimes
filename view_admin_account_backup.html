<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Islamic App Admin Accounts View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ====================================================================
        1. Base & Utilities (DARK THEME VARIABLES)
        ==================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        /* --- NEW THEME COLORS --- */
        :root {
            --color-dark-bg: #172B26; /* Dark background */
            --color-card-bg: #213A33; /* Slightly lighter for main container */
            --color-primary-green: #10b981; /* Tailwind emerald-500 equivalent */
            --color-dark-primary-green: #059669; /* Tailwind emerald-600 equivalent */
            --color-text-light: #e5e7eb; /* Light text for dark backgrounds */
            --color-text-medium: #a1a1aa; /* Muted text */
            --color-border-dark: #374151; /* Darker border for contrast */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-dark-bg); /* THEME CHANGE */
            color: var(--color-text-light); /* Base text color for visibility */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ====================================================================
        2. Component Styles (DARK THEME ADJUSTMENTS)
        ==================================================================== */
        .data-card {
            background: var(--color-card-bg); /* THEME CHANGE */
            /* The border-radius: 12px; and border-top: 5px solid ... have been removed */
            /* Darker shadow for dark theme */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* NEW: Style for individual account containers */
        .account-card {
            background-color: #2c443e; /* A muted dark green, slightly darker than the main container for contrast */
            border-left: 5px solid var(--color-primary-green);
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .account-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); /* Subtle green glow on hover */
        }

        .account-detail-label {
            color: var(--color-text-medium);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }
        .account-detail-value {
            color: var(--color-text-light);
            font-weight: 500;
            font-size: 1rem;
        }
        .account-detail-value.role {
            color: var(--color-primary-green);
            font-weight: 700;
        }

        /* Style for the search input */
        #search-input {
            background-color: #172B26; /* Dark background for input */
            color: var(--color-text-light);
            border: 1px solid var(--color-border-dark);
            padding: 10px 15px;
            border-radius: 6px;
            transition: border-color 0.2s;
        }

        #search-input:focus {
            outline: none;
            border-color: var(--color-primary-green);
            box-shadow: 0 0 0 1px var(--color-primary-green);
        }

        /* NEW: Current User Banner Styles */
        .current-user-banner {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid #10b981;
        }

        .current-user-label {
            color: #d1fae5;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 5px;
        }

        .current-user-value {
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--color-card-bg);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px 24px 0;
            border-bottom: 1px solid var(--color-border-dark);
            margin-bottom: 20px;
        }

        .modal-body {
            padding: 0 24px 20px;
        }

        .modal-footer {
            padding: 16px 24px 24px;
            border-top: 1px solid var(--color-border-dark);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-text-light);
        }

        .form-input {
            width: 100%;
            background-color: #172B26;
            color: var(--color-text-light);
            border: 1px solid var(--color-border-dark);
            padding: 10px 15px;
            border-radius: 6px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-primary-green);
            box-shadow: 0 0 0 1px var(--color-primary-green);
        }

        /* Delete Button Styles - MOVED BELOW NAME */
        .delete-btn {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
            width: 100%;
        }

        .delete-btn:hover {
            background-color: #dc2626;
        }

        .delete-btn:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }

        .delete-btn:disabled:hover {
            background-color: #6b7280;
        }

        /* Button Styles */
        .btn-primary {
            background-color: var(--color-primary-green);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--color-dark-primary-green);
        }

        .btn-secondary {
            background-color: #4b5563;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-secondary:hover {
            background-color: #374151;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        /* Confirmation Modal Styles */
        .confirmation-modal {
            max-width: 400px;
        }

        .confirmation-message {
            text-align: center;
            margin-bottom: 20px;
        }

        .confirmation-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
    </style>
</head>
<body class="flex items-start justify-center min-h-screen p-0">

<main class="w-full mx-auto max-w-4xl pt-8 pb-8">
    <div class="data-card p-6 sm:p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-emerald-400">Admin Accounts Overview</h2>
            <button id="create-admin-btn" class="btn-primary">Create New Admin</button>
        </div>

        <p class="text-center text-gray-400 mb-6">List of Admin Accounts.</p>

        <!-- NEW: Current Username Display -->
        <div id="current-user-banner" class="current-user-banner">
            <div class="current-user-label">Currently Viewing As</div>
            <div id="current-username" class="current-user-value">Loading...</div>
        </div>

        <div class="mb-6">
            <input type="text" id="search-input"
                   placeholder="Search by Username or Last Name..."
                   class="w-full"
                   autocomplete="off" />
        </div>
        <div id="message" class="text-center message mb-4"></div>

        <div id="admin-accounts-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="account-card col-span-1 md:col-span-2 text-center text-gray-400">Loading accounts...</div>
        </div>
    </div>
</main>

<!-- Create Admin Modal -->
<div id="create-admin-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-xl font-bold text-emerald-400">Create New Admin Account</h3>
        </div>
        <div class="modal-body">
            <form id="create-admin-form">
                <div class="form-group">
                    <label class="form-label" for="username">Username</label>
                    <input type="text" id="username" class="form-input" required />
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input type="password" id="password" class="form-input" required />
                </div>
                <div class="form-group">
                    <label class="form-label" for="firstName">First Name</label>
                    <input type="text" id="firstName" class="form-input" required />
                </div>
                <div class="form-group">
                    <label class="form-label" for="middleName">Middle Name</label>
                    <input type="text" id="middleName" class="form-input" />
                </div>
                <div class="form-group">
                    <label class="form-label" for="lastName">Last Name</label>
                    <input type="text" id="lastName" class="form-input" required />
                </div>
                <div class="form-group">
                    <label class="form-label" for="role">Role</label>
                    <select id="role" class="form-input" required>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="cancel-create-btn" class="btn-secondary">Cancel</button>
            <button id="submit-create-btn" class="btn-primary">Create Account</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirmation-modal" class="modal-overlay hidden">
    <div class="modal-content confirmation-modal">
        <div class="modal-header">
            <h3 class="text-xl font-bold text-red-400">Confirm Deletion</h3>
        </div>
        <div class="modal-body">
            <p class="confirmation-message" id="delete-confirmation-message">
                Are you sure you want to delete this admin account? This action cannot be undone.
            </p>
        </div>
        <div class="modal-footer confirmation-actions">
            <button id="cancel-delete-btn" class="btn-secondary">Cancel</button>
            <button id="confirm-delete-btn" class="btn-danger">Delete</button>
        </div>
    </div>
</div>

<script type="module">
    // Import necessary functions for reading data
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
        getFirestore,
        collection,
        getDocs,
        addDoc,
        deleteDoc,
        doc,
        setDoc,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Firebase configuration remains the same
    const firebaseConfig = {
        apiKey: "AIzaSyByJOqTUojiL1wN7_i_cHMAukuJWzIZVck",
        authDomain: "clothsuggest.firebaseapp.com",
        projectId: "clothsuggest",
        storageBucket: "clothsuggest.activity.appspot.com",
        messagingSenderId: "758790774735",
        appId: "1:758790774735:web:5f5ea17048273416cd7cba",
        measurementId: "G-4H8WZL0S4F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const accountsContainer = document.getElementById("admin-accounts-container");
    const messageDiv = document.getElementById("message");
    const searchInput = document.getElementById("search-input");
    const currentUsernameElement = document.getElementById("current-username");
    const createAdminBtn = document.getElementById("create-admin-btn");
    const createAdminModal = document.getElementById("create-admin-modal");
    const cancelCreateBtn = document.getElementById("cancel-create-btn");
    const submitCreateBtn = document.getElementById("submit-create-btn");
    const createAdminForm = document.getElementById("create-admin-form");
    const deleteConfirmationModal = document.getElementById("delete-confirmation-modal");
    const cancelDeleteBtn = document.getElementById("cancel-delete-btn");
    const confirmDeleteBtn = document.getElementById("confirm-delete-btn");
    const deleteConfirmationMessage = document.getElementById("delete-confirmation-message");

    let allAdminAccounts = [];
    let accountToDelete = null;
    let currentUsername = ''; // Store current username globally

    // NEW: Function to get current username from Android interface
    function getCurrentUsername() {
        try {
            if (typeof Android !== 'undefined' && Android.getUsername) {
                const username = Android.getUsername();
                return username || 'Unknown User';
            } else {
                console.log('Android interface not available - using fallback');
                return 'Current User';
            }
        } catch (error) {
            console.error('Error getting username from Android:', error);
            return 'Current User';
        }
    }

    // NEW: Function to display current username
    function displayCurrentUsername() {
        currentUsername = getCurrentUsername();
        currentUsernameElement.textContent = currentUsername;

        // Add a subtle highlight if it's "Admin" (default)
        if (currentUsername === 'Admin') {
            currentUsernameElement.innerHTML = currentUsername + ' <span class="text-yellow-300 text-sm">(Default)</span>';
        }
    }

    // Function to format the date
    const formatDate = (timestamp) => {
        if (timestamp && timestamp.toDate) {
            return timestamp.toDate().toLocaleDateString() + ' ' + timestamp.toDate().toLocaleTimeString();
        }
        return 'N/A';
    }

    // Function to render a single account card
    const renderAccountCard = (docId, data) => {
        const name = [data.firstName, data.middleName, data.lastName]
            .filter(n => n && n.trim() !== '')
            .join(' ');

        // Check if this is the current user's account
        const isCurrentUser = docId === currentUsername;

        // Create delete button with appropriate state
        const deleteButton = isCurrentUser
            ? `<button class="delete-btn" disabled title="You cannot delete your own account">Delete Account (Current User)</button>`
            : `<button class="delete-btn" data-docid="${docId}" data-name="${name}">Delete Account</button>`;

        // Add current user indicator
        const currentUserIndicator = isCurrentUser
            ? `<div class="absolute top-3 right-3 bg-emerald-500 text-white text-xs px-2 py-1 rounded-full">Current User</div>`
            : '';

        return `
            <div class="account-card ${isCurrentUser ? 'border-emerald-400' : ''}">
                ${currentUserIndicator}
                <h3 class="text-xl font-bold text-white mb-3 break-words">${name || 'N/A'}</h3>
                ${deleteButton}

                <div class="grid grid-cols-2 gap-3 border-t border-gray-700 pt-3 mt-4">
                    <div>
                        <p class="account-detail-label">Role</p>
                        <p class="account-detail-value role capitalize">${data.role || 'user'}</p>
                    </div>
                    <div>
                        <p class="account-detail-label">Username</p>
                        <p class="account-detail-value break-all">${docId}</p>
                    </div>
                    <div class="col-span-2">
                        <p class="account-detail-label">Created At</p>
                        <p class="account-detail-value text-gray-400">${formatDate(data.createdAt)}</p>
                    </div>
                </div>
            </div>
        `;
    }

    // Function to render accounts based on a filtered list
    const renderAccounts = (accountsToRender) => {
        accountsContainer.innerHTML = ''; // Clear container
        if (accountsToRender.length === 0) {
            accountsContainer.innerHTML = `<div class="account-card col-span-1 md:col-span-2 text-center text-gray-400">No accounts match your search criteria.</div>`;
        } else {
            accountsToRender.forEach(account => {
                accountsContainer.insertAdjacentHTML('beforeend', renderAccountCard(account.docId, account.data));
            });

            // Add event listeners to delete buttons (only for enabled buttons)
            document.querySelectorAll('.delete-btn:not(:disabled)').forEach(button => {
                button.addEventListener('click', handleDeleteClick);
            });
        }
    }

    // Function to filter accounts
    const filterAccounts = () => {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
            renderAccounts(allAdminAccounts);
            return;
        }

        const filtered = allAdminAccounts.filter(account => {
            const data = account.data;
            const docId = account.docId.toLowerCase();
            const lastName = data.lastName ? data.lastName.toLowerCase() : '';

            // Filter by Username (which is docId) or Last Name
            return docId.includes(searchTerm) || lastName.includes(searchTerm);
        });

        renderAccounts(filtered);
    };

    // Function to show modal
    const showModal = (modal) => {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    // Function to hide modal
    const hideModal = (modal) => {
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scrolling
    }

    // Function to handle create admin form submission
    const handleCreateAdmin = async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const firstName = document.getElementById('firstName').value.trim();
        const middleName = document.getElementById('middleName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const role = document.getElementById('role').value;

        // Validate form
        if (!username || !password || !firstName || !lastName) {
            showMessage('Please fill in all required fields.', 'error');
            return;
        }

        // Check if username already exists
        const usernameExists = allAdminAccounts.some(account => account.docId === username);
        if (usernameExists) {
            showMessage('Username already exists. Please choose a different one.', 'error');
            return;
        }

        try {
            // Show loading state
            submitCreateBtn.disabled = true;
            submitCreateBtn.textContent = 'Creating...';

            // Create new admin account in Firestore with username as document ID
            // Using setDoc instead of addDoc to specify the document ID
            await setDoc(doc(db, "islamicadmin", username), {
                firstName,
                middleName,
                lastName,
                role,
                password: password, // This is just for demonstration - use proper password hashing in production
                createdAt: serverTimestamp()
            });

            // Success
            showMessage(`Admin account "${username}" created successfully!`, 'success');
            hideModal(createAdminModal);
            createAdminForm.reset();

            // Refresh the accounts list
            fetchAdminAccounts();

        } catch (error) {
            console.error("Error creating admin account: ", error);
            showMessage('Failed to create admin account. Please try again.', 'error');
        } finally {
            // Reset button state
            submitCreateBtn.disabled = false;
            submitCreateBtn.textContent = 'Create Account';
        }
    };

    // Function to handle delete button click
    const handleDeleteClick = (e) => {
        const docId = e.target.getAttribute('data-docid');
        const name = e.target.getAttribute('data-name');

        // Prevent deletion of current user's account
        if (docId === currentUsername) {
            showMessage('You cannot delete your own account.', 'error');
            return;
        }

        accountToDelete = docId;
        deleteConfirmationMessage.textContent = `Are you sure you want to delete the admin account "${name}" (${docId})? This action cannot be undone.`;

        showModal(deleteConfirmationModal);
    };

    // Function to handle account deletion
    const handleDeleteAccount = async () => {
        if (!accountToDelete) return;

        // Double-check: Prevent deletion of current user's account
        if (accountToDelete === currentUsername) {
            showMessage('You cannot delete your own account.', 'error');
            hideModal(deleteConfirmationModal);
            accountToDelete = null;
            return;
        }

        try {
            // Show loading state
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = 'Deleting...';

            // Delete the document from Firestore
            await deleteDoc(doc(db, "islamicadmin", accountToDelete));

            // Success
            showMessage(`Admin account "${accountToDelete}" deleted successfully!`, 'success');
            hideModal(deleteConfirmationModal);

            // Refresh the accounts list
            fetchAdminAccounts();

        } catch (error) {
            console.error("Error deleting admin account: ", error);
            showMessage('Failed to delete admin account. Please try again.', 'error');
        } finally {
            // Reset state
            accountToDelete = null;
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.textContent = 'Delete';
        }
    };

    // Function to show message
    const showMessage = (message, type = 'info') => {
        messageDiv.textContent = message;
        messageDiv.className = 'text-center message mb-4';

        switch(type) {
            case 'success':
                messageDiv.classList.add('text-emerald-400');
                break;
            case 'error':
                messageDiv.classList.add('text-red-400');
                break;
            case 'warning':
                messageDiv.classList.add('text-yellow-400');
                break;
            default:
                messageDiv.classList.add('text-gray-400');
        }
    };

    const fetchAdminAccounts = async () => {
        accountsContainer.innerHTML = ''; // Clear the initial loading message
        showMessage("Loading accounts...", 'info');

        try {
            const querySnapshot = await getDocs(collection(db, "islamicadmin"));
            allAdminAccounts = []; // Reset the global array

            if (querySnapshot.empty) {
                showMessage("⚠️ No admin accounts found in the 'islamicadmin' collection.", 'warning');
                accountsContainer.innerHTML = `<div class="account-card col-span-1 md:col-span-2 text-center text-gray-400">No accounts found.</div>`;
                return;
            }

            // Populate the global array
            querySnapshot.forEach((doc) => {
                allAdminAccounts.push({
                    docId: doc.id,
                    data: doc.data()
                });
            });

            // Initial render of all accounts
            renderAccounts(allAdminAccounts);

            showMessage(`Successfully loaded ${querySnapshot.size} admin accounts.`, 'success');
            console.log(`Successfully loaded ${querySnapshot.size} documents from 'islamicadmin'.`);

        } catch (e) {
            // Error Feedback
            console.error("Error fetching documents: ", e);
            showMessage("❌ An error occurred while fetching accounts. Please check the console for details.", 'error');
            accountsContainer.innerHTML = `<div class="account-card col-span-1 md:col-span-2 text-center text-red-400">Error loading data.</div>`;
        }
    };

    // Initialize event listeners
    const initEventListeners = () => {
        // Search input
        searchInput.addEventListener('input', filterAccounts);

        // Create admin modal
        createAdminBtn.addEventListener('click', () => showModal(createAdminModal));
        cancelCreateBtn.addEventListener('click', () => {
            hideModal(createAdminModal);
            createAdminForm.reset();
        });
        submitCreateBtn.addEventListener('click', handleCreateAdmin);

        // Delete confirmation modal
        cancelDeleteBtn.addEventListener('click', () => hideModal(deleteConfirmationModal));
        confirmDeleteBtn.addEventListener('click', handleDeleteAccount);

        // Close modals when clicking outside
        [createAdminModal, deleteConfirmationModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal(modal);
                    if (modal === createAdminModal) {
                        createAdminForm.reset();
                    }
                }
            });
        });
    };

    // NEW: Initialize current username display
    document.addEventListener('DOMContentLoaded', function() {
        displayCurrentUsername();
        initEventListeners();
    });

    // Also try when window loads (backup)
    window.onload = function() {
        setTimeout(displayCurrentUsername, 100);
    };

    // Fetch accounts when the script runs
    fetchAdminAccounts();
</script>

</body>
</html>