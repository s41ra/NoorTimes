<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | Islamic App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ====================================================================
        1. Base & Utilities (DARK THEME - LANDSCAPE)
        User preference: I am using landscape style.
        ==================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #172B26; /* Dark Theme Background */
            color: #f1f5f9; /* Tailwind slate-100 for default text */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* Card Container for both List and Form */
        .list-card, .form-card {
            background: #213A33; /* Card Background */
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        /* Field labels/Headers */
        .field-label {
            font-size: 0.75rem;
            color: #94a3b8; /* Tailwind slate-400 - Light gray for labels */
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        /* Form Input/Textarea/Search Styling */
        .app-input, .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: #1e3a33; /* Darker background */
            border: 1px solid #2c473f;
            border-radius: 8px;
            color: #f1f5f9;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .app-input:focus, .search-input:focus {
            outline: none;
            border-color: #34d399; /* Emerald-400 focus ring */
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5);
        }
        textarea.app-input {
            resize: vertical;
        }

        /* Primary Button (SMS Submit) */
        .app-button-primary {
            background-color: #059669; /* Emerald-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            width: 100%;
        }
        .app-button-primary:hover {
            background-color: #047857; /* Emerald-700 */
        }


        /* Individual User Item */
        .user-item {
            border-bottom: 1px solid #2c473f; /* Darker line separator */
            padding: 1rem 0;
            transition: background-color 0.2s;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .user-item:hover {
            background-color: transparent; 
            margin: 0; 
            padding: 1rem 0;
            border-radius: 0;
        }

        /* User Username/ID text */
        .user-id-text {
            font-size: 0.95rem;
            color: #34d399; /* Emerald-400 */
            font-weight: 700;
        }
    </style>
</head>
<body class="flex flex-col items-center p-4">

<main class="w-full max-w-4xl mx-auto pt-4 pb-4">
    <h1 class="text-3xl font-extrabold text-white mb-8 text-center">Admin Panel</h1>

    <div class="form-card mb-8">
        <h2 class="text-xl font-bold text-gray-100 mb-6">Send Event SMS Notification</h2>
        <form id="sms-event-form" class="space-y-4">
            <div>
                <label for="event-title" class="field-label">Event Title</label>
                <input
                    type="text"
                    id="event-title"
                    class="app-input"
                    placeholder="e.g., Friday Prayer at the Main Mosque"
                    required
                />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="event-date" class="field-label">Date</label>
                    <input
                        type="date"
                        id="event-date"
                        class="app-input"
                        required
                    />
                </div>
                <div>
                    <label for="event-time" class="field-label">Time</label>
                    <input
                        type="time"
                        id="event-time"
                        class="app-input"
                        required
                    />
                </div>
            </div>

            <div>
                <label for="event-description" class="field-label">SMS Message / Description</label>
                <textarea
                    id="event-description"
                    class="app-input"
                    rows="3"
                    maxlength="160"
                    placeholder="Keep it brief (max 160 characters for a standard SMS)."
                    required
                ></textarea>
            </div>

            <button type="submit" id="sms-submit-button" class="app-button-primary">
                Send SMS Notification to All Users
            </button>
            <p id="sms-status" class="text-center text-sm font-medium mt-2 hidden"></p>
        </form>
    </div>
    
    <div class="list-card">
        <h2 class="text-xl font-bold text-gray-100 mb-6">Registered Users: Username & Mobile</h2>
        <div class="mb-6">
            <input 
                type="text" 
                id="search-users" 
                placeholder="Search by Username/ID or Mobile Number..." 
                class="search-input"
                aria-label="Search users"
            >
        </div>
        <div class="grid grid-cols-12 text-sm font-semibold mb-4 text-gray-400 border-b border-gray-600 pb-2 uppercase tracking-wider">
            <div class="col-span-6">Username (ID)</div>
            <div class="col-span-6">Mobile Phone</div>
        </div>

        <div id="users-list-container">
            <p id="loading-status" class="text-center text-gray-400 font-medium mt-8">Loading user data from Firestore...</p>
            <p id="error-status" class="text-center text-red-400 font-medium mt-8 hidden"></p>
        </div>
        
        <p id="no-users" class="text-center text-gray-400 font-medium mt-8 hidden">
            No users found.
        </p>
        <p id="no-search-results" class="text-center text-gray-400 font-medium mt-8 hidden">
            No users match your search criteria.
        </p>
    </div>

</main>

<script type="module">
    // --- 1. Firebase Setup & Initialization ---
    // NOTE: We only need initializeApp and getFirestore for fetching users.
    // addDoc is no longer needed since we are sending SMS directly via API.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyByJOqTUojiL1wN7_i_cHMAukuJWzIZVck",
        authDomain: "clothsuggest.firebaseapp.com",
        databaseURL: "https://clothsuggest-default-rtdb.firebaseio.com/",
        projectId: "clothsuggest",
        storageBucket: "clothsuggest.firebasestorage.app",
        messagingSenderId: "758790774735",
        appId: "1:758790774735:web:5f5ea17048273416cd7cba",
        measurementId: "G-4H8WZL0S4F"
    };

    const app = initializeApp(firebaseConfig);
    const dbFirestore = getFirestore(app);

    // --- 2. DOM Elements & Global State ---
    const usersListContainer = document.getElementById("users-list-container");
    const searchInput = document.getElementById("search-users");
    const smsForm = document.getElementById("sms-event-form");
    const smsStatusEl = document.getElementById("sms-status");
    const smsSubmitButton = document.getElementById("sms-submit-button");
    
    let allUsersData = [];

    // --- INFOBIP API CONFIGURATION ---
    const INFOBIP_BASE_URL = "https://yp26p9.api.infobip.com";
    const INFOBIP_ENDPOINT = `${INFOBIP_BASE_URL}/sms/2/text/advanced`;
    const INFOBIP_API_KEY = "f954175469fe6eef86a2f9aaa76b4da8-bd0471c8-5a3f-4506-84eb-ca53f6bc1914";
    const INFOBIP_SENDER = "447491163443"; // Your sender number
    // ---------------------------------

    /**
     * Helper function to send an SMS to a single number via Infobip API.
     * @param {string} to The recipient mobile number.
     * @param {string} message The SMS content.
     */
    const sendInfobipSms = async (to, message) => {
        // Infobip typically requires the international format (e.g., 639XXXXXXXXX).
        // This logic mimics the conversion from your original Infobip implementation.
        let updatedNumber = to;
        if (updatedNumber.startsWith('09')) {
            updatedNumber = '63' + updatedNumber.slice(1); // Converts '09...' to '639...'
        } else if (!updatedNumber.startsWith('63')) {
             // Fallback for numbers without '0' or '63' prefix, prepend '63'
             updatedNumber = '63' + updatedNumber;
        }

        const myHeaders = new Headers();
        myHeaders.append("Authorization", `App ${INFOBIP_API_KEY}`);
        myHeaders.append("Content-Type", "application/json");
        myHeaders.append("Accept", "application/json");

        const raw = JSON.stringify({
            "messages": [
                {
                    "destinations": [
                        { "to": updatedNumber }
                    ],
                    "from": INFOBIP_SENDER,
                    "text": message
                }
            ]
        });

        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
        };

        const response = await fetch(INFOBIP_ENDPOINT, requestOptions);
        const result = await response.json();
        
        if (response.ok) {
            return { success: true, number: updatedNumber, result };
        } else {
            // Infobip returns a non-200 for errors, the body contains error details
            const errorMessage = result.requestError?.serviceException?.text || 'Unknown API Error';
            return { success: false, number: updatedNumber, error: errorMessage };
        }
    };


    // --- 3. SMS Form Logic ---
    const handleSmsSubmit = async (e) => {
        e.preventDefault();
        
        smsStatusEl.classList.add('hidden');
        smsSubmitButton.disabled = true;
        smsSubmitButton.textContent = 'Sending SMS in Progress...';

        const eventTitle = document.getElementById("event-title").value.trim();
        const eventDate = document.getElementById("event-date").value;
        const eventTime = document.getElementById("event-time").value;
        const eventDescription = document.getElementById("event-description").value.trim();
        
        // Final message to be sent to the users
        const fullMessage = `EVENT: ${eventTitle} | Date: ${eventDate} @ ${eventTime}. Message: ${eventDescription}`;

        if (allUsersData.length === 0) {
            smsStatusEl.textContent = '❌ No registered users found to send SMS to.';
            smsStatusEl.classList.remove('text-green-400');
            smsStatusEl.classList.add('text-red-400');
            smsStatusEl.classList.remove('hidden');
            smsSubmitButton.disabled = false;
            smsSubmitButton.textContent = 'Send SMS Notification to All Users';
            return;
        }

        let successfulSends = 0;
        let failedSends = 0;

        // Use a simple loop to send to all collected mobile numbers
        for (const user of allUsersData) {
            const mobileNumber = user.mobile_phone;
            
            if (!mobileNumber) {
                console.warn(`User ${user.userId} has no mobile number.`);
                continue; // Skip users without a number
            }

            try {
                const result = await sendInfobipSms(mobileNumber, fullMessage);
                
                if (result.success) {
                    successfulSends++;
                } else {
                    failedSends++;
                    console.error(`Failed to send to ${result.number}: ${result.error}`);
                }
            } catch (error) {
                failedSends++;
                console.error(`Network error sending to ${mobileNumber}: ${error.message}`);
            }
        }
        
        // Update UI status after all messages have been processed
        const statusMessage = `✅ Finished sending! Successful: ${successfulSends}. Failed: ${failedSends}.`;
        smsStatusEl.textContent = statusMessage;
        smsStatusEl.classList.remove('hidden', 'text-red-400');
        smsStatusEl.classList.add(failedSends > 0 ? 'text-yellow-400' : 'text-green-400');
        smsForm.reset(); 

        smsSubmitButton.disabled = false;
        smsSubmitButton.textContent = 'Send SMS Notification to All Users';
    };


    // --- 4. Utility Functions (User List Rendering/Filtering - No Change) ---
    const createUserItemHtml = (user) => {
        const listMobilePhone = user.mobile_phone || 'N/A';
        
        // Username is derived from the signup code
        const usernameDisplay = user.userId || 'N/A'; // Using userId as the source based on your configuration
        
        return `
            <div class="user-item grid grid-cols-12 items-center">
                <div class="col-span-6 break-words">
                    <span class="user-id-text">${usernameDisplay}</span>
                </div>
                <div class="col-span-6 text-sm text-gray-200 break-words">
                    ${listMobilePhone}
                </div>
            </div>
        `;
    };

    const renderUserList = (users) => {
        const loadingStatusEl = document.getElementById("loading-status");
        const noUsersEl = document.getElementById("no-users");
        const noSearchResultsEl = document.getElementById("no-search-results");

        if (searchInput.value.trim() === '') {
            usersListContainer.innerHTML = '';
        }
        
        loadingStatusEl.classList.add('hidden');
        noSearchResultsEl.classList.add('hidden');
        noUsersEl.classList.add('hidden');

        if (users.length === 0) {
            if (searchInput.value.trim() !== '' && allUsersData.length > 0) {
                noSearchResultsEl.classList.remove('hidden');
            } else if (searchInput.value.trim() === '' && allUsersData.length === 0) {
                noUsersEl.classList.remove('hidden'); 
            }
            return;
        }

        const usersHtml = users.map(createUserItemHtml).join('');
        usersListContainer.innerHTML = usersHtml;
    };

    const filterUsers = () => {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (searchTerm === '') {
            renderUserList(allUsersData);
            return;
        }

        const filteredUsers = allUsersData.filter(user => {
            const usernameMatch = (user.userId || '').toLowerCase().includes(searchTerm);
            const mobileMatch = (user.mobile_phone || '').toLowerCase().includes(searchTerm);
            
            return usernameMatch || mobileMatch;
        });

        renderUserList(filteredUsers);
    };


    // --- 5. Main Logic (Data Fetch with Realtime Listener - No Change) ---
    function setupUserRealtimeListener() {
        const loadingStatusEl = document.getElementById("loading-status");
        const errorStatusEl = document.getElementById("error-status");
        
        loadingStatusEl.classList.remove('hidden');
        errorStatusEl.classList.add('hidden');

        const usersCollectionRef = collection(dbFirestore, "islamusers");

        const unsubscribe = onSnapshot(usersCollectionRef, (snapshot) => {
            loadingStatusEl.classList.add('hidden');
            allUsersData = []; 

            snapshot.forEach(doc => {
                const data = doc.data();
                const userId = doc.id; 
                
                allUsersData.push({
                    userId: userId,
                    ...data 
                });
            });

            allUsersData.sort((a, b) => (a.userId || '').localeCompare(b.userId || ''));

            // Re-render the filtered list
            filterUsers();
            
        }, (error) => {
            console.error("Error getting real-time user list:", error);
            loadingStatusEl.classList.add('hidden');
            errorStatusEl.textContent = `Failed to stream user list: ${error.message}`;
            errorStatusEl.classList.remove('hidden');
        });
    }

    // --- 6. Execution and Event Listeners ---
    searchInput.addEventListener('input', filterUsers);
    smsForm.addEventListener('submit', handleSmsSubmit);
    setupUserRealtimeListener();
</script>

</body>
</html>