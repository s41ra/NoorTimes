<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All Users List | Islamic App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ====================================================================
        1. Base & Utilities (DARK THEME - LANDSCAPE/PORTRAIT)
        ==================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #172B26; /* Dark Theme Background */
            color: #f1f5f9; /* Tailwind slate-100 for default text */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* User Card Container */
        .user-card {
            background: #213A33; /* Card Background */
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        /* Field labels/Headers */
        .field-label {
            font-size: 0.75rem;
            color: #94a3b8; /* Tailwind slate-400 - Light gray for labels */
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* New Input field styling for editing */
        .edit-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background-color: #1e3a33; /* Darker background */
            border: 1px solid #2c473f;
            border-radius: 6px;
            color: #f1f5f9;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        .edit-input:focus {
            outline: none;
            border-color: #34d399;
        }

        /* User Username/ID text */
        .user-id-text {
            font-size: 0.95rem;
            color: #34d399; /* Emerald-400 */
            font-weight: 700;
        }
        /* Search Bar Styling */
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: #1e3a33; /* Darker background */
            border: 1px solid #2c473f;
            border-radius: 8px;
            color: #f1f5f9;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: #34d399; /* Emerald-400 focus ring */
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Dark semi-transparent backdrop */
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #213A33; /* Card Background */
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            color: #f1f5f9;
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }
        /* Modal Profile Image Style */
        .modal-profile-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #2c473f;
            border: 2px solid #34d399;
            margin: 0 auto 1rem;
        }

        /* Delete Button Styling */
        .delete-button {
            background-color: #dc2626; /* Tailwind red-600 */
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .delete-button:hover {
            background-color: #b91c1c; /* Tailwind red-700 */
        }
        .delete-button:disabled {
            background-color: #6b7280; /* Tailwind gray-500 */
            cursor: not-allowed;
        }

        /* Confirmation Modal Styling */
        .confirmation-modal {
            max-width: 350px;
        }
        .confirmation-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        .cancel-button {
            background-color: #6b7280; /* Tailwind gray-500 */
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .cancel-button:hover {
            background-color: #4b5563; /* Tailwind gray-600 */
        }
        .confirm-delete-button {
            background-color: #dc2626; /* Tailwind red-600 */
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .confirm-delete-button:hover {
            background-color: #b91c1c; /* Tailwind red-700 */
        }

        /* User Profile Image in Cards */
        .user-card-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #2c473f;
            border: 2px solid #34d399;
        }
    </style>
</head>
<body class="flex flex-col items-center">

<main class="w-full max-w-6xl px-4">
    <h2 class="text-2xl font-bold text-gray-100 mb-6 text-center pt-4">All Registered Users</h2>

    <div class="list-card">
        <div class="mb-6">
            <input
                    type="text"
                    id="search-users"
                    placeholder="Search by Username/ID or Full Name..."
                    class="search-input"
                    aria-label="Search users"
            >
        </div>

        <div id="users-list-container">
            <p id="loading-status" class="text-center text-gray-400 font-medium mt-8">Loading user data from Firestore...</p>
            <p id="error-status" class="text-center text-red-400 font-medium mt-8 hidden"></p>
        </div>

        <p id="no-users" class="text-center text-gray-400 font-medium mt-8 hidden">
            No users found in the Firestore 'islamusers' collection.
        </p>
        <p id="no-search-results" class="text-center text-gray-400 font-medium mt-8 hidden">
            No users match your search criteria.
        </p>
    </div>

</main>

<!-- User Profile Modal -->
<div id="user-profile-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close-button" onclick="closeModal()">×</button>
        <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2 text-center">User Profile Details</h3>

        <div class="flex justify-between mb-4">
            <button id="modal-delete-button" class="delete-button">
                Delete Account
            </button>
            <button id="modal-edit-button" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-1 px-3 rounded text-sm transition-colors duration-200">
                Edit
            </button>
        </div>

        <div class="text-center mb-4">
            <img id="modal-profile-photo" class="modal-profile-image"
                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 016 0zm6 3a9 9 0 11-18 0 9 9 3 0118 0z' /%3E%3C/svg%3E"
                 alt="Profile Picture"
            />
            <p id="modal-userId" class="text-xl user-id-text font-bold"></p>
        </div>

        <div id="modal-fields" class="space-y-3 pt-4 border-t border-gray-700">
            <div data-field="full_name">
                <span class="field-label">Full Name</span>
                <p id="modal-fullName" class="text-gray-100 font-medium"></p>
            </div>
            <div data-field="mobile_phone">
                <span class="field-label">Mobile Phone</span>
                <p id="modal-mobilePhone" class="text-gray-300"></p>
                <p id="mobile-error" class="text-red-400 text-xs mt-1 hidden">Mobile number is already registered.</p>
            </div>
            <div data-field="location">
                <span class="field-label">Location</span>
                <div id="modal-location-display">
                    <p id="modal-location" class="text-gray-300 text-sm"></p>
                </div>
                <div id="modal-location-inputs" class="space-y-2 hidden">
                    <input type="text" id="input-barangay" placeholder="Barangay" class="edit-input text-sm" />
                    <input type="text" id="input-city" placeholder="City/Municipality" class="edit-input text-sm" />
                    <input type="text" id="input-province" placeholder="Province" class="edit-input text-sm" />
                </div>
            </div>
            <div data-field="password">
                <span class="field-label">Password (Only set new password to change)</span>
                <p id="modal-password" class="text-gray-300 font-mono text-sm break-all"></p>
            </div>
            <div id="photo-url-container">
                <span class="field-label">Profile Photo Status</span>
                <button id="modal-viewPhotoButton" class="hidden bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-1 px-3 rounded text-sm transition-colors duration-200">
                    View Photo
                </button>
                <p id="modal-photoStatus" class="text-gray-400 text-sm"></p>
            </div>
            <p id="modal-status-message" class="text-center text-sm font-medium mt-4 hidden"></p>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirmation-modal" class="modal-overlay" onclick="closeDeleteConfirmationModal(event)">
    <div class="modal-content confirmation-modal" onclick="event.stopPropagation()">
        <button class="modal-close-button" onclick="closeDeleteConfirmationModal()">×</button>
        <h3 class="text-xl font-bold mb-4 text-center">Confirm Account Deletion</h3>

        <div class="mb-4">
            <p class="text-gray-300 mb-2">You are about to delete the account for:</p>
            <p id="delete-user-id" class="text-xl user-id-text font-bold text-center"></p>
            <p id="delete-user-name" class="text-gray-300 text-center"></p>
        </div>

        <div class="bg-red-900/30 border border-red-700 rounded-lg p-3 mb-4">
            <p class="text-red-300 text-sm font-medium">⚠️ This action cannot be undone. All user data will be permanently deleted.</p>
        </div>

        <div class="confirmation-buttons">
            <button class="cancel-button" onclick="closeDeleteConfirmationModal()">Cancel</button>
            <button id="confirm-delete-button" class="confirm-delete-button">Delete Account</button>
        </div>
    </div>
</div>

<script type="module">
    // --- 1. Firebase Setup & Initialization ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref as rtdbRef, get, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
    import { getFirestore, collection, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyByJOqTUojiL1wN7_i_cHMAukuJWzIZVck",
        authDomain: "clothsuggest.firebaseapp.com",
        databaseURL: "https://clothsuggest-default-rtdb.firebaseio.com/",
        projectId: "clothsuggest",
        storageBucket: "clothsuggest.firebasestorage.app",
        messagingSenderId: "758790774735",
        appId: "1:758790774735:web:5f5ea17048273416cd7cba",
        measurementId: "G-4H8WZL0S4F"
    };

    const app = initializeApp(firebaseConfig);
    const dbFirestore = getFirestore(app);
    const dbRTDB = getDatabase(app);

    // --- 2. DOM Elements & Global State ---
    const usersListContainer = document.getElementById("users-list-container");
    const searchInput = document.getElementById("search-users");
    const modalOverlay = document.getElementById("user-profile-modal");
    const deleteConfirmationModal = document.getElementById("delete-confirmation-modal");

    // Status/Utility Elements
    const modalEditButton = document.getElementById("modal-edit-button");
    const modalDeleteButton = document.getElementById("modal-delete-button");
    const modalStatusMessage = document.getElementById("modal-status-message");
    const confirmDeleteButton = document.getElementById("confirm-delete-button");
    const getMobileErrorEl = () => document.getElementById("mobile-error");
    const modalProfilePhotoEl = document.getElementById("modal-profile-photo");
    const modalPhotoStatusEl = document.getElementById("modal-photoStatus");

    // Display Elements
    const modalLocationDisplay = document.getElementById("modal-location-display");
    const modalLocationInputs = document.getElementById("modal-location-inputs");

    // Input elements for Edit Mode
    let inputFullName, inputMobilePhone, inputPassword;

    // Global State
    let allUsersData = [];
    let currentUserId = null;
    let isEditMode = false;
    const placeholderSVG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 016 0zm6 3a9 9 0 11-18 0 9 9 3 0118 0z' /%3E%3C/svg%3E";

    // --- 3. Modal Functions & Toggles ---

    // Converts display <p> elements to <input> fields
    const createInput = (id, value, type = 'text', readOnly = false) => {
        const input = document.createElement('input');
        input.id = id;
        input.type = type;
        input.value = value || '';
        input.className = 'edit-input';
        if(readOnly) {
            input.readOnly = true;
            input.placeholder = "Username cannot be changed";
        }
        return input;
    };

    const toggleEditMode = (user) => {
        const mobileErrorEl = getMobileErrorEl();
        if(mobileErrorEl) mobileErrorEl.classList.add('hidden');

        if (!isEditMode) {
            // ENTER EDIT MODE
            isEditMode = true;
            modalEditButton.textContent = 'Save Changes';
            modalEditButton.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            modalEditButton.classList.add('bg-green-600', 'hover:bg-green-500');

            // Disable delete button while in edit mode
            modalDeleteButton.disabled = true;

            // 1. Full Name
            const fullNameDiv = document.querySelector('[data-field="full_name"]');
            fullNameDiv.innerHTML = `<span class="field-label">Full Name</span>`;
            inputFullName = createInput('input-fullName', user.full_name);
            fullNameDiv.appendChild(inputFullName);

            // 2. Mobile Phone
            const mobilePhoneDiv = document.querySelector('[data-field="mobile_phone"]');
            mobilePhoneDiv.innerHTML = `<span class="field-label">Mobile Phone</span>`;
            inputMobilePhone = createInput('input-mobilePhone', user.mobile_phone, 'tel');
            mobilePhoneDiv.appendChild(inputMobilePhone);
            const errorEl = getMobileErrorEl();
            if(errorEl) mobilePhoneDiv.appendChild(errorEl);

            // 3. Location
            modalLocationDisplay.classList.add('hidden');
            modalLocationInputs.classList.remove('hidden');
            document.getElementById('input-barangay').value = user.barangay || '';
            document.getElementById('input-city').value = user.city_municipality || '';
            document.getElementById('input-province').value = user.province || '';

            // 4. Password
            const passwordDiv = document.querySelector('[data-field="password"]');
            passwordDiv.innerHTML = `<span class="field-label">Password (Leave blank to keep current)</span>`;
            inputPassword = createInput('input-password', '', 'password');
            inputPassword.placeholder = "Enter new password to change";
            passwordDiv.appendChild(inputPassword);

        } else {
            // EXIT EDIT MODE
            isEditMode = false;
            modalEditButton.textContent = 'Edit';
            modalEditButton.classList.remove('bg-green-600', 'hover:bg-green-500');
            modalEditButton.classList.add('bg-blue-600', 'hover:bg-blue-500');

            // Re-enable delete button
            modalDeleteButton.disabled = false;

            // Restore display fields
            showUserDetailsModal(currentUserId, true);
        }
    };

    // Helper to check for mobile phone duplication
    const isMobileDuplicate = (newMobile, currentUserId) => {
        return allUsersData.some(user =>
            user.mobile_phone === newMobile && user.userId !== currentUserId
        );
    };

    const saveChanges = async () => {
        if (!isEditMode || !currentUserId) return;

        // Display "Saving changes..." state immediately
        modalStatusMessage.textContent = 'Saving changes...';
        modalStatusMessage.className = 'text-center text-sm font-medium mt-4 text-yellow-400';
        modalStatusMessage.classList.remove('hidden');

        const mobileErrorEl = getMobileErrorEl();
        if(mobileErrorEl) mobileErrorEl.classList.add('hidden');

        const newMobile = inputMobilePhone.value.trim();

        // 1. Mobile Phone Validation
        if (newMobile && isMobileDuplicate(newMobile, currentUserId)) {
            modalStatusMessage.textContent = 'Validation failed: The mobile number is already in use.';
            modalStatusMessage.className = 'text-center text-sm font-medium mt-4 text-red-400';
            if(mobileErrorEl) mobileErrorEl.classList.remove('hidden');
            return;
        }

        const updatedData = {
            full_name: inputFullName.value.trim() || null,
            mobile_phone: newMobile || null,
            barangay: document.getElementById('input-barangay').value.trim() || null,
            city_municipality: document.getElementById('input-city').value.trim() || null,
            province: document.getElementById('input-province').value.trim() || null,
        };

        const newPassword = inputPassword.value.trim();
        if (newPassword) {
            updatedData.password = newPassword;
        }

        try {
            const userRef = doc(dbFirestore, "islamusers", currentUserId);
            await updateDoc(userRef, updatedData);

            // Update local cache
            const userIndex = allUsersData.findIndex(u => u.userId === currentUserId);
            if (userIndex !== -1) {
                allUsersData[userIndex] = { ...allUsersData[userIndex], ...updatedData };
            }

            modalStatusMessage.textContent = 'Successfully updated! Refreshing page...';
            modalStatusMessage.className = 'text-center text-sm font-medium mt-4 text-green-400';

            const updatedUser = allUsersData.find(u => u.userId === currentUserId);

            // Exit edit mode
            if (updatedUser) {
                toggleEditMode(updatedUser);
            }

            // Force page refresh after success
            setTimeout(() => {
                 window.location.reload();
            }, 1000);

        } catch (error) {
            console.error("Error during Firestore write:", error);
            modalStatusMessage.textContent = 'Error saving changes.';
            modalStatusMessage.className = 'text-center text-sm font-medium mt-4 text-red-400';

            setTimeout(() => {
                 modalStatusMessage.classList.add('hidden');
            }, 3000);
        }
    };

    // --- DELETE USER FUNCTIONALITY ---
    const deleteUserAccount = async () => {
        if (!currentUserId) return;

        // Show loading state
        confirmDeleteButton.disabled = true;
        confirmDeleteButton.textContent = 'Deleting...';

        try {
            // 1. Delete from Firestore
            const userRef = doc(dbFirestore, "islamusers", currentUserId);
            await deleteDoc(userRef);

            // 2. Delete from Realtime Database (profile photo)
            const profilePicRef = rtdbRef(dbRTDB, `user_profile/${currentUserId}`);
            await remove(profilePicRef);

            // 3. Update local state
            allUsersData = allUsersData.filter(user => user.userId !== currentUserId);

            // 4. Close modals
            closeDeleteConfirmationModal();
            closeModal();

            // 5. Show success message and refresh page
            modalStatusMessage.textContent = 'User account deleted successfully. Refreshing page...';
            modalStatusMessage.className = 'text-center text-sm font-medium mt-4 text-green-400';
            modalStatusMessage.classList.remove('hidden');

            // Force page refresh after successful deletion
            setTimeout(() => {
                window.location.reload();
            }, 1500);

        } catch (error) {
            console.error("Error deleting user account:", error);

            // Show error message
            modalStatusMessage.textContent = 'Error deleting user account.';
            modalStatusMessage.className = 'text-center text-sm font-medium mt-4 text-red-400';
            modalStatusMessage.classList.remove('hidden');

            // Reset delete button
            confirmDeleteButton.disabled = false;
            confirmDeleteButton.textContent = 'Delete Account';

            // Hide error message after delay
            setTimeout(() => {
                modalStatusMessage.classList.add('hidden');
            }, 3000);
        }
    };

    const showDeleteConfirmationModal = (userId) => {
        const user = allUsersData.find(u => u.userId === userId);
        if (!user) return;

        document.getElementById('delete-user-id').textContent = user.userId;
        document.getElementById('delete-user-name').textContent = user.full_name || 'No name provided';

        // Reset delete button state
        confirmDeleteButton.disabled = false;
        confirmDeleteButton.textContent = 'Delete Account';

        deleteConfirmationModal.style.display = 'flex';
    };

    const closeDeleteConfirmationModal = (event) => {
        if (event && event.target !== deleteConfirmationModal) {
            return;
        }
        deleteConfirmationModal.style.display = 'none';
    };

    // Event listener for the Edit/Save button
    modalEditButton.addEventListener('click', () => {
        if (isEditMode) {
            saveChanges();
        } else {
            const user = allUsersData.find(u => u.userId === currentUserId);
            if (user) toggleEditMode(user);
        }
    });

    // Event listener for the Delete button
    modalDeleteButton.addEventListener('click', () => {
        if (currentUserId) {
            showDeleteConfirmationModal(currentUserId);
        }
    });

    // Event listener for the Confirm Delete button
    confirmDeleteButton.addEventListener('click', deleteUserAccount);

    window.showUserDetailsModal = async (userId, isRefresh = false) => {
        const user = allUsersData.find(u => u.userId === userId);

        if (!user) {
            console.error(`User with ID ${userId} not found.`);
            return;
        }

        currentUserId = userId;
        modalStatusMessage.classList.add('hidden');
        const mobileErrorEl = getMobileErrorEl();
        if(mobileErrorEl) mobileErrorEl.classList.add('hidden');

        // If not a refresh, ensure it's in display mode
        if (!isRefresh && isEditMode) {
            isEditMode = false;
            modalEditButton.textContent = 'Edit';
            modalEditButton.classList.remove('bg-green-600', 'hover:bg-green-500');
            modalEditButton.classList.add('bg-blue-600', 'hover:bg-blue-500');
            modalDeleteButton.disabled = false;
        }

        // Reset photo elements and status
        const modalUserIdEl = document.getElementById("modal-userId");
        modalUserIdEl.textContent = user.userId;

        modalProfilePhotoEl.src = placeholderSVG;
        modalPhotoStatusEl.classList.remove('hidden');
        modalPhotoStatusEl.textContent = 'Checking for profile photo...';
        document.getElementById("modal-viewPhotoButton").classList.add('hidden');

        // 1. Populate all display fields from Firestore data
        const createFieldDisplay = (label, value, id, isMono = false) => `
            <div data-field="${id}">
                <span class="field-label">${label}</span>
                <p id="${id}" class="text-gray-100 ${isMono ? 'font-mono text-sm break-all' : 'font-medium'}">${value}</p>
            </div>
        `;

        const locationText = [user.barangay, user.city_municipality, user.province]
                                     .filter(Boolean)
                                     .join(', ') || 'Location Not Set';

        document.querySelector('[data-field="full_name"]').innerHTML = createFieldDisplay('Full Name', user.full_name || 'N/A', 'modal-fullName');

        document.querySelector('[data-field="mobile_phone"]').innerHTML = createFieldDisplay('Mobile Phone', user.mobile_phone || 'N/A', 'modal-mobilePhone') + `<p id="mobile-error" class="text-red-400 text-xs mt-1 hidden">Mobile number is already registered.</p>`;

        const locationDiv = document.querySelector('[data-field="location"]');
        locationDiv.innerHTML = `
            <span class="field-label">Location</span>
            <div id="modal-location-display">
                <p id="modal-location" class="text-gray-300 text-sm">${locationText}</p>
            </div>
            <div id="modal-location-inputs" class="space-y-2 hidden">
                <input type="text" id="input-barangay" placeholder="Barangay" class="edit-input text-sm" />
                <input type="text" id="input-city" placeholder="City/Municipality" class="edit-input text-sm" />
                <input type="text" id="input-province" placeholder="Province" class="edit-input text-sm" />
            </div>
        `;
        document.querySelector('[data-field="password"]').innerHTML = createFieldDisplay('Password (Demo Value)', user.password || 'Not Set', 'modal-password', true);

        // Re-check for edit mode state
        if (isEditMode) {
            toggleEditMode(user);
        } else {
             document.getElementById("modal-location-display").classList.remove('hidden');
             document.getElementById("modal-location-inputs").classList.add('hidden');
        }

        // 2. Fetch Profile Picture URL from Realtime Database (RTDB)
        const profilePicRef = rtdbRef(dbRTDB, `user_profile/${user.userId}/imageurl`);
        try {
            const picSnapshot = await get(profilePicRef);

            if (picSnapshot.exists() && picSnapshot.val()) {
                const photoUrl = picSnapshot.val();
                modalProfilePhotoEl.src = photoUrl;
                modalPhotoStatusEl.classList.add('hidden');
            } else {
                modalPhotoStatusEl.textContent = 'Profile photo not uploaded.';
            }
        } catch (error) {
            console.error("Error loading profile picture URL from RTDB:", error);
            modalPhotoStatusEl.textContent = 'Error loading photo.';
        }

        // 3. Display the modal
        modalOverlay.style.display = 'flex';
    };

    window.closeModal = (event) => {
        if (event && event.target !== modalOverlay) {
            return;
        }
        if(isEditMode) {
            const user = allUsersData.find(u => u.userId === currentUserId);
            if(user) toggleEditMode(user);
        }
        modalOverlay.style.display = 'none';
        modalStatusMessage.classList.add('hidden');
    };

    // --- 4. Utility Functions ---

    const createUserCardHtml = (user) => {
        const safeUserId = user.userId.replace(/'/g, "\\'");
        const locationText = [user.barangay, user.city_municipality, user.province]
                                     .filter(Boolean)
                                     .join(', ') || 'Location Not Set';
        const fullName = user.full_name || 'N/A';
        const mobilePhone = user.mobile_phone || 'N/A';

        // Create a unique ID for the delete button
        const deleteButtonId = `delete-btn-${user.userId.replace(/[^a-zA-Z0-9]/g, '-')}`;

        return `
            <div class="user-card" onclick="window.showUserDetailsModal('${safeUserId}')">
                <div class="flex items-center mb-4">
                    <img class="user-card-image mr-4"
                         src="${placeholderSVG}"
                         alt="Profile Picture"
                         id="card-photo-${user.userId}"
                    />
                    <div>
                        <h3 class="user-id-text text-lg">${user.userId}</h3>
                        <p class="text-gray-300 text-sm">${fullName}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="field-label">Mobile</span>
                        <p class="text-gray-300">${mobilePhone}</p>
                    </div>
                    <div>
                        <span class="field-label">Location</span>
                        <p class="text-gray-300 text-xs">${locationText}</p>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="${deleteButtonId}" class="delete-button text-xs py-1 px-2">
                        Delete Account
                    </button>
                </div>
            </div>
        `;
    };

    const renderUserCards = (users) => {
        const loadingStatusEl = document.getElementById("loading-status");
        const noUsersEl = document.getElementById("no-users");
        const noSearchResultsEl = document.getElementById("no-search-results");

        if (searchInput.value.trim() === '') {
            usersListContainer.innerHTML = '';
        }

        loadingStatusEl.classList.add('hidden');
        noSearchResultsEl.classList.add('hidden');
        noUsersEl.classList.add('hidden');

        if (users.length === 0) {
            if (searchInput.value.trim() !== '' && allUsersData.length > 0) {
                noSearchResultsEl.classList.remove('hidden');
            } else if (searchInput.value.trim() === '' && allUsersData.length === 0) {
                noUsersEl.classList.remove('hidden');
            }
            return;
        }

        // Create a grid container for the cards
        usersListContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${users.map(createUserCardHtml).join('')}
            </div>
        `;

        // Load profile pictures for each card
        users.forEach(user => {
            loadProfilePictureForCard(user.userId);
        });

        // Add event listeners to delete buttons after rendering
        users.forEach(user => {
            const deleteButtonId = `delete-btn-${user.userId.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const deleteButton = document.getElementById(deleteButtonId);
            if (deleteButton) {
                deleteButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    showDeleteConfirmationModal(user.userId);
                });
            }
        });
    };

    const loadProfilePictureForCard = async (userId) => {
        const profilePicRef = rtdbRef(dbRTDB, `user_profile/${userId}/imageurl`);
        try {
            const picSnapshot = await get(profilePicRef);
            if (picSnapshot.exists() && picSnapshot.val()) {
                const photoUrl = picSnapshot.val();
                const cardPhotoEl = document.getElementById(`card-photo-${userId}`);
                if (cardPhotoEl) {
                    cardPhotoEl.src = photoUrl;
                }
            }
        } catch (error) {
            console.error(`Error loading profile picture for card ${userId}:`, error);
        }
    };

    const filterUsers = () => {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (searchTerm === '') {
            renderUserCards(allUsersData);
            return;
        }

        const filteredUsers = allUsersData.filter(user => {
            const usernameMatch = user.userId.toLowerCase().includes(searchTerm);
            const nameMatch = (user.full_name || '').toLowerCase().includes(searchTerm);

            return usernameMatch || nameMatch;
        });

        renderUserCards(filteredUsers);
    };

    // --- 5. Main Logic (Data Fetch with Realtime Listener) ---

    function setupUserRealtimeListener() {
        const loadingStatusEl = document.getElementById("loading-status");
        const errorStatusEl = document.getElementById("error-status");

        // Show loading status initially
        loadingStatusEl.classList.remove('hidden');
        errorStatusEl.classList.add('hidden');

        const usersCollectionRef = collection(dbFirestore, "islamusers");

        // Use onSnapshot to listen for real-time changes
        const unsubscribe = onSnapshot(usersCollectionRef, (snapshot) => {
            loadingStatusEl.classList.add('hidden');
            allUsersData = [];

            snapshot.forEach(doc => {
                const data = doc.data();
                const userId = doc.id;

                allUsersData.push({
                    userId: userId,
                    ...data
                });
            });

            // Re-sort the users for consistent display
            allUsersData.sort((a, b) => a.userId.localeCompare(b.userId));

            // Re-render the filtered list
            filterUsers();

            // If the modal for the currently viewed user is open, refresh its data
            if (currentUserId && modalOverlay.style.display === 'flex') {
                const updatedUser = allUsersData.find(u => u.userId === currentUserId);
                if (updatedUser && !isEditMode) {
                    showUserDetailsModal(currentUserId, true);
                }
            }

        }, (error) => {
            console.error("Error getting real-time user list:", error);
            loadingStatusEl.classList.add('hidden');
            errorStatusEl.textContent = `Failed to stream user list: ${error.message}`;
            errorStatusEl.classList.remove('hidden');
        });
    }

    // --- 6. Execution and Event Listeners ---
    searchInput.addEventListener('input', filterUsers);
    setupUserRealtimeListener();

    // Make functions globally available
    window.showDeleteConfirmationModal = showDeleteConfirmationModal;
    window.closeDeleteConfirmationModal = closeDeleteConfirmationModal;
</script>

</body>
</html>